<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering" /><meta name="author" content="Sebastian Claesson" /><meta property="og:locale" content="en" /><meta name="description" content="Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering" /><meta property="og:description" content="Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering" /><link rel="canonical" href="https://blog.sebastianclaesson.se/posts/AzureCrossTenantCollaboration/" /><meta property="og:url" content="https://blog.sebastianclaesson.se/posts/AzureCrossTenantCollaboration/" /><meta property="og:site_name" content="Sebastian Claesson" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-03T14:55:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering" /><meta name="twitter:site" content="@SebClaesson" /><meta name="twitter:creator" content="@Sebastian Claesson" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sebastian Claesson"},"dateModified":"2024-10-06T10:32:00+02:00","datePublished":"2023-04-03T14:55:00+02:00","description":"Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering","headline":"Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sebastianclaesson.se/posts/AzureCrossTenantCollaboration/"},"url":"https://blog.sebastianclaesson.se/posts/AzureCrossTenantCollaboration/"}</script><title>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering | Sebastian Claesson</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sebastian Claesson"><meta name="application-name" content="Sebastian Claesson"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/images/ps_black_128.svg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sebastian Claesson</a></div><div class="site-subtitle font-italic">Techblog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/SebastianClaesson" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/SebClaesson" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sebastianclaesson','hotmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1680526500" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 3, 2023 </em> </span> <span> Updated <em class="" data-ts="1728203520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 6, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1220 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p>The possibility to create Virtual network peerings across Azure Active Directory tenants has been available since 2018. <br /> It’s a feature which is allowed by default and is quite easy to setup and get started with. <br /> It helps provide private networking between two Azure AD tenants subscriptions and can be an alternative to private link/private endpoints etc. <br /> This post will go through the setup and requirements, but also how you can detect cross-tenant collaboration &amp; blocking it. <br /> I will not deep-dive into all the toolings around it, such as Conditional access or other features you get available by using <a href="https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-mfa-licensing">Azure AD Premium</a>.</p><h2 id="azure-ad-settings--invitation-process"><span class="mr-2">Azure AD settings &amp; invitation process</span><a href="#azure-ad-settings--invitation-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Tenant A is a new Tenant, out-of-box, with no customization done to External collaboration settings. Out of box, external collaboration settings: <a href="/assets/images/2023/SourceGuestSettings.png" class="popup img-link "><img data-src="/assets/images/2023/SourceGuestSettings.png" alt="Tenant A - External Collaboration" class="lazyload" data-proofer-ignore></a> <br /> This means that anyone in the Tenant A organization can invite guest users and that it may be sent to any domain. <br /> If we head over to Cross-tenant access settings, we can also see that B2B collaboration access settings are allowed both inbound and outbound.</p><blockquote class="prompt-info"><p>Reference: <a href="https://learn.microsoft.com/en-us/azure/active-directory/external-identities/cross-tenant-access-overview#default-settings">Cross-tenant access settings</a></p></blockquote><p>We attempt to reach the Azure AD Tenant A from the user in Tenant B, without being invited as a guest to that tenant.</p><p><a href="/assets/images/2023/TenantBInteractionWithoutInvitation.png" class="popup img-link "><img data-src="/assets/images/2023/TenantBInteractionWithoutInvitation.png" alt="Tenant B to Tenant A - External Collaboration attempt 1" class="lazyload" data-proofer-ignore></a></p><p>If you are inviting a user that does not have an E-mail address, you can use for example PowerShell to create and consume an invitation.</p><blockquote class="prompt-info"><p>Reference: <a href="https://learn.microsoft.com/en-us/azure/active-directory/external-identities/b2b-quickstart-invite-powershell">Invite guest user - PowerShell</a></p></blockquote><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nv">$params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">InvitedUserDisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Sebastian Guest user"</span><span class="w">
    </span><span class="nx">InvitedUserEmailAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sebastian.claesson@contoso.com"</span><span class="w">
    </span><span class="nx">InviteRedirectUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://myapplications.microsoft.com"</span><span class="w">
    </span><span class="nx">SendInvitationMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$Invite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-MgInvitation</span><span class="w"> </span><span class="err">@</span><span class="nx">params</span><span class="w">

</span><span class="nv">$invite</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span><span class="n">select-object</span><span class="w"> </span><span class="nx">Id</span><span class="p">,</span><span class="w"> </span><span class="nx">InviteRedeemUrl</span><span class="p">,</span><span class="w"> </span><span class="nx">InvitedUserDisplayName</span><span class="p">,</span><span class="w"> </span><span class="nx">InvitedUserEmailAddress</span><span class="p">,</span><span class="w"> </span><span class="nx">InvitedUserType</span><span class="p">,</span><span class="w"> </span><span class="nx">Status</span><span class="p">,</span><span class="w"> </span><span class="p">@{</span><span class="s1">'n'</span><span class="o">=</span><span class="s1">'UserId'</span><span class="p">;</span><span class="s1">'E'</span><span class="o">=</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">InvitedUser</span><span class="o">.</span><span class="nf">Id</span><span class="p">}}</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span><span class="n">ConvertTo-Json</span><span class="w">
</span></pre></table></code></div></div><p>The response from the invitation is as following:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"Id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"51b5db20-6630-4776-a183-288f78dff904"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"InviteRedeemUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://login.microsoftonline.com/redeem?rd=https%3a%2f%2finvitations.microsoft.com%2fredeem%2f%3ftenant%3d31ca78c2-d833-433a-9977-88e160bd4ac0%26user%3d51b5db20-6630-4776-a183-288f78dff904%26ticket%3dHq53w18dK78ZhChJlhx37EDD9i3xIQBIUc9uDoqurwQ%25253d%26ver%3d2.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"InvitedUserDisplayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Sebastian Guest user"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"InvitedUserEmailAddress"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sebastian.claesson@contoso.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"InvitedUserType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Guest"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PendingAcceptance"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"UserId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a9cf0759-4de1-4ee2-85a6-47ff8f4e34f0"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Once we consume the InviteRedeemUrl, we simply go to the invited user’s context and browse to the link.</p><p><a href="/assets/images/2023/TenantBInvitationRedeemProcess.png" class="popup img-link "><img data-src="/assets/images/2023/TenantBInvitationRedeemProcess.png" alt="Tenant B User consumes invitation" class="lazyload" data-proofer-ignore></a></p><p>Once the invitation has been accepted, we can verify that the user has been created in Tenant A by running</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">Get-MgUser</span><span class="w"> </span><span class="nt">-userId</span><span class="w"> </span><span class="nv">$Invite</span><span class="o">.</span><span class="nf">InvitedUser</span><span class="o">.</span><span class="nf">Id</span><span class="w">

</span><span class="c"># Output</span><span class="w">
</span><span class="n">Id</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">a9cf0759-4de1-4ee2-85a6-47ff8f4e34f0</span><span class="w">
</span><span class="n">DisplayName</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">Sebastian</span><span class="w"> </span><span class="nx">Claesson</span><span class="w">
</span><span class="n">UserPrincipalName</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">sebastian.claesson_contoso.com</span><span class="c">#EXT#@tenantA.onmicrosoft.com</span><span class="w">
</span></pre></table></code></div></div><h2 id="lets-try-to-establish-a-network-peering-from-tenant-b-to-tenant-a-using-the-portal-experience"><span class="mr-2">Lets try to establish a network peering from Tenant B to Tenant A using the Portal experience.</span><a href="#lets-try-to-establish-a-network-peering-from-tenant-b-to-tenant-a-using-the-portal-experience" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="/assets/images/2023/TenantBtoTenantAPeerAttempt1.png" class="popup img-link "><img data-src="/assets/images/2023/TenantBtoTenantAPeerAttempt1.png" alt="Tenant B Peering attempt" class="lazyload" data-proofer-ignore></a> We receive the error:</p><pre><code class="language-plain">Failed to add virtual network peering 'TenantB2TenantA' to 'vnet-demo-test'. 
Error: The client 'sebastian.claesson@contoso.com' with object id '30d70e94-10e8-494d-bece-ea990d773b47' has permission to perform action 'Microsoft.Network/virtualNetworks/virtualNetworkPeerings/write' on scope 'demo-test-rg/providers/Microsoft.Network/virtualNetworks/vnet-demo-test/virtualNetworkPeerings/TenantB2TenantA' &gt; vnet-demo-test/TenantB2TenantA'; 
however, it does not have permission to perform action 'peer/action' on the linked scope(s) '/subscriptions/8655f4d3-0bb1-4be0-b73c-6a8f3b304cf6/resourceGroups/demo-rg/providers/Microsoft.Network/virtualNetworks/demo-vnet' or the linked scope(s) are invalid.
</code></pre><p>This means we’re only invited as a guest with no Azure Resource access in target subscription. <br /> We’ll assign our Tenant B user the role of “Network Contributor” in the correct subscription of Tenant A and make a new attempt. <br /> To confirm that the peering has been initiated we can run the following command:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">Get-AzVirtualNetworkPeering</span><span class="w"> </span><span class="nt">-VirtualNetworkName</span><span class="w"> </span><span class="s2">"vnet-demo-test"</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="s2">"demo-test-rg"</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span><span class="n">Select</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="p">@{</span><span class="s1">'N'</span><span class="o">=</span><span class="s1">'RemoteVnetId'</span><span class="p">;</span><span class="s1">'E'</span><span class="o">=</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">RemoteVirtualNetwork</span><span class="o">.</span><span class="nf">Id</span><span class="p">}},</span><span class="w"> </span><span class="nx">PeeringSyncLevel</span><span class="p">,</span><span class="w"> </span><span class="nx">PeeringState</span><span class="p">,</span><span class="w"> </span><span class="nx">ProvisioningState</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">

</span><span class="n">Name</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">TenantB2TenantA</span><span class="w">
</span><span class="n">RemoteVnetId</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">/subscriptions/8655f4d3-0bb1-4be0-b73c-6a8f3b304cf6/resourceGroups/demo-rg/providers/Microsoft.Network/virtualNetworks/demo-vnet</span><span class="w">
</span><span class="n">PeeringSyncLevel</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nx">RemoteNotInSync</span><span class="w">
</span><span class="n">PeeringState</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">Initiated</span><span class="w">
</span><span class="n">ProvisioningState</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Succeeded</span><span class="w">
</span></pre></table></code></div></div><p>As indicated, the peering has been initiated, however not completed.<br /> When checking the status of the remote virtual network we are trying to peer with, we can see that there’s been no peering created. <a href="/assets/images/2023/TenantAVnetPeerStatus.png" class="popup img-link "><img data-src="/assets/images/2023/TenantAVnetPeerStatus.png" alt="Tenant A Peerings" class="lazyload" data-proofer-ignore></a> <br /> This means we’ll have to estalish a peer from Tenant A to Tenant B.<br /> The easiest way is simply to change tenant in the invited user’s context and establish the peering using the portal experience.<br /> To confirm a successful peering, we can run the following PowerShell command</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">Get-AzVirtualNetworkPeering</span><span class="w"> </span><span class="nt">-VirtualNetworkName</span><span class="w"> </span><span class="s1">'demo-vnet'</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="s1">'demo-rg'</span><span class="w"> </span><span class="o">|</span><span class="w"> 
</span><span class="n">Select</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="p">@{</span><span class="s1">'N'</span><span class="o">=</span><span class="s1">'RemoteVnetId'</span><span class="p">;</span><span class="s1">'E'</span><span class="o">=</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">RemoteVirtualNetwork</span><span class="o">.</span><span class="nf">Id</span><span class="p">}},</span><span class="w">  </span><span class="p">@{</span><span class="s1">'N'</span><span class="o">=</span><span class="s1">'RemoteVirtualNetworkAddressSpace'</span><span class="p">;</span><span class="s1">'E'</span><span class="o">=</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">RemoteVirtualNetworkAddressSpace</span><span class="o">.</span><span class="nf">AddressPrefixes</span><span class="p">}},</span><span class="w"> </span><span class="nx">PeeringSyncLevel</span><span class="p">,</span><span class="w"> </span><span class="nx">PeeringState</span><span class="p">,</span><span class="w"> </span><span class="nx">ProvisioningState</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">

</span><span class="c"># Output</span><span class="w">
</span><span class="n">Name</span><span class="w">                             </span><span class="p">:</span><span class="w"> </span><span class="nx">TenantA2TenantB</span><span class="w">
</span><span class="n">RemoteVnetId</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nx">/subscriptions/31bdf544-8e8e-4f5b-bb31-3316a05e5581/resourceGroups/demo-test-rg/providers/Microsoft.Network/virtualNetworks/vnet-demo-test</span><span class="w">
</span><span class="n">RemoteVirtualNetworkAddressSpace</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">192.168.1.0/24</span><span class="w">
</span><span class="n">PeeringSyncLevel</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="nx">FullyInSync</span><span class="w">
</span><span class="n">PeeringState</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nx">Connected</span><span class="w">
</span><span class="n">ProvisioningState</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">Succeeded</span><span class="w">

</span><span class="n">Get-AzVirtualNetworkPeering</span><span class="w"> </span><span class="nt">-VirtualNetworkName</span><span class="w"> </span><span class="s2">"vnet-demo-test"</span><span class="w"> </span><span class="nt">-ResourceGroupName</span><span class="w"> </span><span class="s2">"demo-test-rg"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nx">Name</span><span class="p">,</span><span class="w"> </span><span class="p">@{</span><span class="s1">'N'</span><span class="o">=</span><span class="s1">'RemoteVnetId'</span><span class="p">;</span><span class="s1">'E'</span><span class="o">=</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">RemoteVirtualNetwork</span><span class="o">.</span><span class="nf">Id</span><span class="p">}},</span><span class="w"> </span><span class="p">@{</span><span class="s1">'N'</span><span class="o">=</span><span class="s1">'RemoteVirtualNetworkAddressSpace'</span><span class="p">;</span><span class="s1">'E'</span><span class="o">=</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">RemoteVirtualNetworkAddressSpace</span><span class="o">.</span><span class="nf">AddressPrefixes</span><span class="p">}},</span><span class="w"> </span><span class="nx">PeeringSyncLevel</span><span class="p">,</span><span class="w"> </span><span class="nx">PeeringState</span><span class="p">,</span><span class="w"> </span><span class="nx">ProvisioningState</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">

</span><span class="n">Name</span><span class="w">                             </span><span class="p">:</span><span class="w"> </span><span class="nx">TenantB2TenantA</span><span class="w">
</span><span class="n">RemoteVnetId</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nx">/subscriptions/8655f4d3-0bb1-4be0-b73c-6a8f3b304cf6/resourceGroups/demo-rg/providers/Microsoft.Network/virtualNetworks/demo-vnet</span><span class="w">
</span><span class="n">RemoteVirtualNetworkAddressSpace</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">10.0.0.0/16</span><span class="w">
</span><span class="n">PeeringSyncLevel</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="nx">FullyInSync</span><span class="w">
</span><span class="n">PeeringState</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nx">Connected</span><span class="w">
</span><span class="n">ProvisioningState</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">Succeeded</span><span class="w">
</span></pre></table></code></div></div><p>Here we can confirm that the peering between the tenants have been established successfully.<br /> These networks can now access each other and routes has been presented by the peer, as seen in the following screenshot on a NIC inside Tenant B. <a href="/assets/images/2023/TenantBVMRoutes.png" class="popup img-link "><img data-src="/assets/images/2023/TenantBVMRoutes.png" alt="Tenant B VM Routes" class="lazyload" data-proofer-ignore></a></p><h1 id="how-do-we-protect-our-organization-for-cross-tenant-collaboration">How do we protect our Organization for cross-tenant collaboration?</h1><p>You might ask yourself “How do we protect our employees/organization from accidently allowing cross-tenant virtual network peerings to prevent data exfiltration or network communication by-passing the VNA?”.<br /> There are different ways to enforce and detect this some examples could be a controlled process for when BGP is enabled on route tables. <br /> However, if we assume that both Tenants/Organizations have adopted the Landing Zone concept, we know that our developers/users have access to modify route tables, network peerings etc. to manage their LZ. <br /> In this part we’ll focus on how we can prevent cross-tenant collaboration and not on suggested Azure policies to enforce controlled processes around infrastructure/network changes. <br /> We’ll have to go back to the Cross-tenant access settings, specfically the Inbound and Outbound B2B collaboration settings.</p><blockquote class="prompt-info"><p>Note: B2B collaboration settings are not only limited to Azure resource actions, and can include Office 365 and other services.<br /> Reference: <a href="https://learn.microsoft.com/en-us/azure/active-directory/external-identities/cross-tenant-access-settings-b2b-collaboration">Azure AD B2B Collaboration</a></p></blockquote><h2 id="outbound-blocked"><span class="mr-2">Outbound blocked</span><a href="#outbound-blocked" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If we set the Outbound access settings for B2B collaboration to “All blocked”, we can still establish a network peering by following the procedure above.</p><h2 id="inbound-blocked"><span class="mr-2">Inbound blocked</span><a href="#inbound-blocked" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If we set the Inbound access settings for B2B collaboration to “All blocked”, we are unable to establish a peer from Tenant B to Tenant A.</p><p><a href="/assets/images/2023/TenantAPeeringWithTenantBBlockingMessage.png" class="popup img-link "><img data-src="/assets/images/2023/TenantAPeeringWithTenantBBlockingMessage.png" alt="Tenant A blocking inbound" class="lazyload" data-proofer-ignore></a></p><p>We are also unable to login towards the tenant without guest user account. <br /> Receiving the error message above, also with the detailed error “AADSTS500213: The resource tenant’s cross-tenant access policy does not allow this user to access this tenant.”</p><h2 id="detection"><span class="mr-2">Detection</span><a href="#detection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There’s a workbook published in Azure AD that you can utilize if logs are streamed to a log analytics workspace. It’s called “<a href="https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/workbook-cross-tenant-access-activity">Cross-tenant access activity</a>”</p><p>To get a bit more in-depth data on the activity, you can simply take a snippet out of the query such as:</p><pre><code class="language-kql">SigninLogs
    | project TimeGenerated,
        UserPrincipalName,
        HomeTenantId,
        AADTenantId,
        Id,
        ResourceTenantId,
        ResourceDisplayName,
        ResourceIdentity,
        Status,
        UserType,
        UserId
    | where UserId != "00000000-0000-0000-0000-000000000000"
    | where ResourceIdentity != ''
    | where "All users" == "All users" or UserPrincipalName has "All users"
    | where "All applications" == "All applications" or ResourceDisplayName has "All applications"
    | where "All external tenants" == "All external tenants" or HomeTenantId has "All external tenants"
    | where HomeTenantId != ''
    | where HomeTenantId != AADTenantId
    | extend status = case(Status.errorCode == 0, "Success", "Failure")
    | where "All" == status or "All" == "All"
</code></pre><p>Now you’ll visualize each request and you are able to identify each tenant that your users are interacting with. <a href="/assets/images/2023/kqlexample.png" class="popup img-link "><img data-src="/assets/images/2023/kqlexample.png" alt="Dataset" class="lazyload" data-proofer-ignore></a></p><h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It’s a good idea to keep track of possible cross-tenant integrations, may it be using virtual network peerings / private links / private endpoints or by using service endpoints. <br /> This post only covers some of these points and how it can be prevented using other methods than Azure policy or Azure monitor/alert. <br /> <em>This post resulted in a pull request to update Microsoft Learn documentation on <a href="https://github.com/MicrosoftDocs/azure-docs/pull/107640">Pull Request 107640</a>.</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/azure/'>Azure</a>, <a href='/categories/cross-tenant-collaboration/'>Cross-tenant collaboration</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a> <a href="/tags/azure-ad/" class="post-tag no-text-decoration" >azure ad</a> <a href="/tags/network/" class="post-tag no-text-decoration" >network</a> <a href="/tags/cross-tenant/" class="post-tag no-text-decoration" >cross-tenant</a> <a href="/tags/b2b/" class="post-tag no-text-decoration" >b2b</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Azure%20AD%20Cross-tenant%20Collaboration%20/%20VNET%20Cross-tenant%20peering%20-%20Sebastian%20Claesson&url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureCrossTenantCollaboration%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Azure%20AD%20Cross-tenant%20Collaboration%20/%20VNET%20Cross-tenant%20peering%20-%20Sebastian%20Claesson&u=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureCrossTenantCollaboration%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureCrossTenantCollaboration%2F&text=Azure%20AD%20Cross-tenant%20Collaboration%20/%20VNET%20Cross-tenant%20peering%20-%20Sebastian%20Claesson" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SubscriptionVending/">Subscription Vending</a><li><a href="/posts/AzureDevOpsColoredOutput/">Azure DevOps Pipeline Output</a><li><a href="/posts/AzureDevOpsExtension-Linux/">Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</a><li><a href="/posts/AzureCrossTenantCollaboration/">Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</a><li><a href="/posts/AzureFunctions/">PowerShell Azure Function - Managed identity & triggers/bindings</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AzureDevOpsExtension-Linux/"><div class="card-body"> <em class="small" data-ts="1667912100" data-df="ll" > Nov 8, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</h3><div class="text-muted small"><p> Are you looking to run your Azure DevOps agent behind an unauthenticated/authenticated web proxy for traffic destined to the internet? Then hopefully this post will help you straighten out those q...</p></div></div></a></div><div class="card"> <a href="/posts/AzureFunctions/"><div class="card-body"> <em class="small" data-ts="1660229700" data-df="ll" > Aug 11, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PowerShell Azure Function - Managed identity & triggers/bindings</h3><div class="text-muted small"><p> I’ve been playing around a little with Azure Functions and Azure Alerting. The design was to be able to utilize the Azure Alert rule processing function in Azure and have it create a prettier mail ...</p></div></div></a></div><div class="card"> <a href="/posts/SubscriptionVending/"><div class="card-body"> <em class="small" data-ts="1728176100" data-df="ll" > Oct 6, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Subscription Vending</h3><div class="text-muted small"><p> Introduction An important part of Azure Landing Zones is the ability to create Azure subscriptions (landing zones) through automation. Any scripts and code used in this post can be found at: ht...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AzureDevOpsExtension-Linux/" class="btn btn-outline-primary" prompt="Older"><p>Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</p></a> <a href="/posts/SubscriptionVending/" class="btn btn-outline-primary" prompt="Newer"><p>Subscription Vending</p></a></div><script src="https://utteranc.es/client.js" repo="SebastianClaesson/sebastianclaesson.github.io" issue-term="pathname" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/SebClaesson">Sebastian Claesson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LQDR23C4VN"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LQDR23C4VN'); }); </script>
