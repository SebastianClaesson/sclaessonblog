<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Subscription Vending" /><meta name="author" content="Sebastian Claesson" /><meta property="og:locale" content="en" /><meta name="description" content="Subscription Vending guide for Azure Landing Zones" /><meta property="og:description" content="Subscription Vending guide for Azure Landing Zones" /><link rel="canonical" href="https://blog.sebastianclaesson.se/posts/SubscriptionVending/" /><meta property="og:url" content="https://blog.sebastianclaesson.se/posts/SubscriptionVending/" /><meta property="og:site_name" content="Sebastian Claesson" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-10-06T02:55:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Subscription Vending" /><meta name="twitter:site" content="@SebClaesson" /><meta name="twitter:creator" content="@Sebastian Claesson" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sebastian Claesson"},"dateModified":"2024-10-24T08:38:47+02:00","datePublished":"2024-10-06T02:55:00+02:00","description":"Subscription Vending guide for Azure Landing Zones","headline":"Subscription Vending","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sebastianclaesson.se/posts/SubscriptionVending/"},"url":"https://blog.sebastianclaesson.se/posts/SubscriptionVending/"}</script><title>Subscription Vending | Sebastian Claesson</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sebastian Claesson"><meta name="application-name" content="Sebastian Claesson"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/images/ps_black_128.svg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sebastian Claesson</a></div><div class="site-subtitle font-italic">Techblog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/SebastianClaesson" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/SebClaesson" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sebastianclaesson','hotmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Subscription Vending</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Subscription Vending</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1728176100" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 6, 2024 </em> </span> <span> Updated <em class="" data-ts="1729751927" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 24, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1754 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>An important part of Azure Landing Zones is the ability to create Azure subscriptions (landing zones) through automation.</p><blockquote class="prompt-tip"><p>Any scripts and code used in this post can be found at: https://github.com/SebastianClaesson/SubscriptionVendingExample</p></blockquote><h1 id="enterprise-agreement-role-assignment-for-workload-identities">Enterprise Agreement Role Assignment for workload identities</h1><p>There’s an article on <a href="https://learn.microsoft.com/en-us/azure/cost-management-billing/manage/assign-roles-azure-service-principals#permissions-that-can-be-assigned-to-the-service-principal">Microsoft Learn</a> that goes through how to assign a workload identity permissions to an Enterprise Agreement.</p><p>If you are interested in following the least-privileged access model, then we must follow the article above to grant our workload identity access as “SubscriptionCreator” over our enrollment account. The process of subscription vending must not be bound to a employees account or permissions. However, not everyone is comfortable following the guide and take short-cuts such as assigning Enterprise Administrator over the billing account using the IAM controls in Azure.</p><p>To assist with the creation of the EA Role assignment, I’ve created the following script <a href="https://github.com/SebastianClaesson/SubscriptionVendingExample/blob/main/New-EnterpriseAgreementRoleAssignment.ps1">New-EnterpriseAgreementRoleAssignment</a></p><p>Once the assignment has been done, we need to build our subscription vending automation somewhere. This could be an Azure Function, GitHub/Azure DevOps Pipeline, Custom container or part of your self-service portal.</p><h1 id="create-your-first-azure-subscription-using-powershell">Create your first Azure Subscription using PowerShell</h1><p>The <a href="https://www.powershellgallery.com/packages/Az.Subscription">Az.Subscription PowerShell module</a> contains the function “New-AzSubscriptionAlias” to provision a new Azure Subscription.</p><p>We can simply write a function to provision the subscription using our workload identity. The function will run in the current logged in users context.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
</span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">

    </span><span class="c"># BillingScope</span><span class="w">
    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
    </span><span class="nv">$BillingScope</span><span class="p">,</span><span class="w">

    </span><span class="c"># Workload</span><span class="w">
    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
    </span><span class="nv">$Workload</span><span class="p">,</span><span class="w">

    </span><span class="c"># ManagementGroupId</span><span class="w">
    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
    </span><span class="nv">$ManagementGroupId</span><span class="p">,</span><span class="w">

    </span><span class="c"># Identifier</span><span class="w">
    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
    </span><span class="nv">$Identifier</span><span class="p">,</span><span class="w">

    </span><span class="c"># Environment</span><span class="w">
    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
    </span><span class="nv">$EnvironmentShortName</span><span class="p">,</span><span class="w">

    </span><span class="c"># DisplayName</span><span class="w">
    </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
    </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
    </span><span class="nv">$DisplayName</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c"># The script requires the Az PowerShell Module</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Module</span><span class="w"> </span><span class="s1">'Az.Subscription'</span><span class="w"> </span><span class="nt">-ListAvailable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">Throw</span><span class="w"> </span><span class="s1">'Please install the Az PowerShell Module "https://www.powershellgallery.com/packages/Az.Subscription"'</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\Az.Subscription</span><span class="w">

</span><span class="nv">$params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">AliasName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$Identifier</span><span class="s2">-</span><span class="nv">$EnvironmentShortName</span><span class="s2">"</span><span class="err">.</span><span class="nx">toLower</span><span class="err">()</span><span class="w">
    </span><span class="nx">SubscriptionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$DisplayName</span><span class="s2">-</span><span class="nv">$EnvironmentShortName</span><span class="s2">"</span><span class="err">.</span><span class="nx">toLower</span><span class="err">()</span><span class="w">
    </span><span class="nx">BillingScope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$BillingScope</span><span class="w">
    </span><span class="nx">Workload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Workload</span><span class="w">
    </span><span class="nx">ManagementGroupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ManagementGroupId</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">Write-Verbose</span><span class="w"> </span><span class="s2">"Attempting to list any Azure Subscription"</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="nv">$SubAliases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzSubscriptionAlias</span><span class="w">
</span><span class="nx">Write-verbose</span><span class="w"> </span><span class="s2">"Found a total of </span><span class="si">$(</span><span class="nv">$SubAliases</span><span class="o">.</span><span class="nf">Count</span><span class="si">)</span><span class="s2"> Subscription Aliases."</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="nv">$SubAliases</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">AliasName</span><span class="p">,</span><span class="w"> </span><span class="nx">SubscriptionId</span><span class="w">

</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$SubAliases</span><span class="o">.</span><span class="nf">AliasName</span><span class="w"> </span><span class="o">-Contains</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$params</span><span class="o">.</span><span class="nf">AliasName</span><span class="si">)</span><span class="s2">"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$SubscriptionInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$SubAliases</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">AliasName</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">"</span><span class="si">$(</span><span class="nv">$params</span><span class="o">.</span><span class="nf">AliasName</span><span class="si">)</span><span class="s2">"</span><span class="p">}</span><span class="w">
    </span><span class="n">Write-Verbose</span><span class="w"> </span><span class="s2">"The subscription ""</span><span class="si">$(</span><span class="nv">$SubscriptionInfo</span><span class="o">.</span><span class="nf">AliasName</span><span class="si">)</span><span class="s2">"" already exists with id: '</span><span class="si">$(</span><span class="nv">$SubscriptionInfo</span><span class="o">.</span><span class="nf">SubscriptionId</span><span class="si">)</span><span class="s2">', Skipping creation."</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$SubscriptionInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-AzSubscriptionAlias</span><span class="w"> </span><span class="err">@</span><span class="nx">params</span><span class="w">
    
        </span><span class="n">Write-Output</span><span class="w"> </span><span class="nv">$SubscriptionInfo</span><span class="w">
    
        </span><span class="n">Write-verbose</span><span class="w"> </span><span class="s2">"Successfully created the subscription '</span><span class="si">$(</span><span class="nv">$SubscriptionInfo</span><span class="o">.</span><span class="nf">AliasName</span><span class="si">)</span><span class="s2">' with id: '</span><span class="si">$(</span><span class="nv">$SubscriptionInfo</span><span class="o">.</span><span class="nf">SubscriptionId</span><span class="si">)</span><span class="s2">'"</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="kr">throw</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><h2 id="azure-devops-pipeline-example"><span class="mr-2">Azure DevOps pipeline example</span><a href="#azure-devops-pipeline-example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h2 id="configure-service-connection-with-federated-credentials"><span class="mr-2">Configure Service Connection with Federated Credentials</span><a href="#configure-service-connection-with-federated-credentials" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To utilize Azure DevOps for our Workload identity, we can utilize different types of authentication. I strongly recommend that <a href="https://devblogs.microsoft.com/devops/workload-identity-federation-for-azure-deployments-is-now-generally-available/">federated credentials</a> is configured to authenticate our workload identity.</p><p>This means we do not have to manage a client secret, instead we trust the Azure DevOps directory to manage the credentials to our workload identity. As part of the service connection in Azure DevOps, we need to set a Azure Subscription where the pipeline initializes when running Azure PowerShell scripts. This simply can be done by providing for example the <a href="https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles/general#reader">Reader</a> role over a subscription, as we do not need access to any resources.</p><blockquote class="prompt-tip"><p>You must register the resource providers for Management Groups and Subscriptions to successfully run the automation in your initial subscription.</p></blockquote><p>To save time, We’ll also create a script to manage the access and configuration of the service connection.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
</pre><td class="rouge-code"><pre><span class="c">## Requires the module ADOPS</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">New-ADOServiceConnection</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="c"># SubscriptionId</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$SubscriptionId</span><span class="p">,</span><span class="w">

        </span><span class="c"># SubscriptionName</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$SubscriptionName</span><span class="p">,</span><span class="w">

        </span><span class="c"># Environment</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$Environment</span><span class="p">,</span><span class="w">

        </span><span class="c"># Identifier - This can be a project name, Service name or such to identify the Azure Landing Zone</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$Identifier</span><span class="p">,</span><span class="w">

        </span><span class="c"># Azure DevOps Organization</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$ADOOrganization</span><span class="p">,</span><span class="w">

        </span><span class="c"># Azure DevOps Project Name</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$ADOProjectName</span><span class="p">,</span><span class="w">

        </span><span class="c"># Role Defintion Name in Azure to be assigned to our Service Connection over the entire Landing Zone</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$RoleDefinitionName</span><span class="w">
    </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c">## Naming convention</span><span class="w">
</span><span class="nv">$AppRegistrationName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sc-azdo-</span><span class="nv">$ProjectName</span><span class="s2">-</span><span class="nv">$Identifier</span><span class="s2">-</span><span class="nv">$Environment</span><span class="s2">"</span><span class="w">
</span><span class="nv">$ServiceConnectionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sc-</span><span class="nv">$Identifier</span><span class="s2">-</span><span class="nv">$Environment</span><span class="s2">"</span><span class="w">

</span><span class="c"># The script requires the Az PowerShell Module</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Module</span><span class="w"> </span><span class="s1">'Az'</span><span class="w"> </span><span class="nt">-ListAvailable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">Throw</span><span class="w"> </span><span class="s1">'Please install the Az PowerShell Module "https://www.powershellgallery.com/packages/Az"'</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># The script requires the ADOPS PowerShell Module</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">Get-Module</span><span class="w"> </span><span class="s1">'ADOPS'</span><span class="w"> </span><span class="nt">-ListAvailable</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">Throw</span><span class="w"> </span><span class="s1">'Please install the ADOPS PowerShell Module "https://www.powershellgallery.com/packages/ADOPS"'</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Check if the user is already logged in to the Az PowerShell Module.</span><span class="w">
</span><span class="nv">$AzureContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzContext</span><span class="w">
</span><span class="nx">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nv">$AzureContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c"># User is not logged into Az PowerShell Module</span><span class="w">
    </span><span class="n">Write-verbose</span><span class="w"> </span><span class="s2">"Please login to the Az PowerShell Module, this is used for confirming the existance of the Application Id and obtain an Azure Access Token"</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
    </span><span class="n">Connect-AzAccount</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Federated Identity connection for Azure Subscription '</span><span class="si">$(</span><span class="nv">$AzureLandingZone</span><span class="o">.</span><span class="nf">SubscriptionId</span><span class="si">)</span><span class="s2">' as '</span><span class="nv">$RoleDefinitionName</span><span class="s2">'"</span><span class="w">

</span><span class="c">## Azure</span><span class="w">
</span><span class="nv">$TenantId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AzureContext</span><span class="o">.</span><span class="nf">Tenant</span><span class="o">.</span><span class="nf">Id</span><span class="w">

</span><span class="kr">if</span><span class="w"> </span><span class="p">((</span><span class="n">Get-Module</span><span class="w"> </span><span class="nx">Az.Accounts</span><span class="p">)</span><span class="o">.</span><span class="nf">Version</span><span class="w"> </span><span class="o">-lt</span><span class="w"> </span><span class="s1">'4.0.0'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$AccessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Get-AzAccessToken</span><span class="p">)</span><span class="o">.</span><span class="nf">Token</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$AccessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Get-AzAccessToken</span><span class="p">)</span><span class="o">.</span><span class="nf">Token</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-SecureString</span><span class="w"> </span><span class="nt">-AsPlainText</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Verify that the Azure Landing zone exists.</span><span class="w">
</span><span class="nv">$AzureLandingZone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzSubscription</span><span class="w"> </span><span class="nt">-SubscriptionId</span><span class="w"> </span><span class="nv">$SubscriptionId</span><span class="w">

</span><span class="c"># Connects to Azure DevOps</span><span class="w">
</span><span class="n">Connect-ADOPS</span><span class="w"> </span><span class="nt">-Organization</span><span class="w"> </span><span class="nv">$Organization</span><span class="w"> </span><span class="nt">-OAuthToken</span><span class="w"> </span><span class="nv">$AccessToken</span><span class="w">

</span><span class="c"># Gets the Azure DevOps project</span><span class="w">
</span><span class="nv">$AzdoProject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ADOPSProject</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$ProjectName</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$AzdoProject</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Get-ADOPSProject</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nx">Name</span><span class="w">
    </span><span class="kr">Throw</span><span class="w"> </span><span class="s2">"Unable to find </span><span class="nv">$ProjectName</span><span class="s2">"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Gets the Azure DevOps Service Conection, if it already exists.</span><span class="w">
</span><span class="nv">$AdopsSC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ADOPSServiceConnection</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$ServiceConnectionName</span><span class="w"> </span><span class="nt">-Project</span><span class="w"> </span><span class="nv">$ProjectName</span><span class="w"> </span><span class="nt">-IncludeFailed</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$AdopsSC</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$Params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
        </span><span class="nx">TenantId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$TenantId</span><span class="w"> 
        </span><span class="nx">SubscriptionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$SubscriptionName</span><span class="w"> 
        </span><span class="nx">SubscriptionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$SubscriptionId</span><span class="w"> 
        </span><span class="nx">WorkloadIdentityFederation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="w">
        </span><span class="nx">Project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ProjectName</span><span class="w"> 
        </span><span class="nx">ConnectionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ServiceConnectionName</span><span class="err">.</span><span class="nx">ToLower</span><span class="err">()</span><span class="w">
        </span><span class="nx">CreationMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Manual'</span><span class="w">
        </span><span class="nx">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Description</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="nv">$AdopsSC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-ADOPSServiceConnection</span><span class="w"> </span><span class="err">@</span><span class="nx">Params</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Write-Verbose</span><span class="w"> </span><span class="s2">"Found '</span><span class="nv">$ServiceConnectionName</span><span class="s2">' in the Project </span><span class="nv">$ProjectName</span><span class="s2">"</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Creates the Workload identity (Application Registration) using Az Module</span><span class="w">
</span><span class="nv">$EntraIdAppParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">DisplayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$AppRegistrationName</span><span class="s2">"</span><span class="err">.</span><span class="nx">tolower</span><span class="err">()</span><span class="w">
    </span><span class="nx">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Azure DevOps Service Connection used in '</span><span class="nv">$ProjectName</span><span class="s2">' for credential federation."</span><span class="w">
    </span><span class="nx">Confirm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$App</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzADServicePrincipal</span><span class="w"> </span><span class="nt">-DisplayName</span><span class="w"> </span><span class="nv">$EntraIdAppParams</span><span class="o">.</span><span class="nf">DisplayName</span><span class="w">
</span><span class="nx">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$App</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$App</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-AzADServicePrincipal</span><span class="w"> </span><span class="nt">-AccountEnabled</span><span class="w"> </span><span class="err">@</span><span class="nx">EntraIdAppParams</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Write-Verbose</span><span class="w"> </span><span class="s2">"The Entra ID Service Principal '</span><span class="si">$(</span><span class="nv">$App</span><span class="o">.</span><span class="nf">DisplayName</span><span class="si">)</span><span class="s2">' already exists."</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$AppDetails</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzADApplication</span><span class="w"> </span><span class="nt">-ApplicationId</span><span class="w"> </span><span class="nv">$App</span><span class="o">.</span><span class="nf">AppId</span><span class="w">

</span><span class="c"># Creates Entra Id Federated Credentials for authentication between Azure DevOps and Entra id using our Workload identity</span><span class="w">

</span><span class="nv">$FederatedCreds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzADAppFederatedCredential</span><span class="w"> </span><span class="nt">-ApplicationObjectId</span><span class="w"> </span><span class="nv">$AppDetails</span><span class="o">.</span><span class="nf">Id</span><span class="w">

</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$AdopsSC</span><span class="o">.</span><span class="nf">authorization</span><span class="o">.</span><span class="nf">parameters</span><span class="o">.</span><span class="nf">workloadIdentityFederationSubject</span><span class="w"> </span><span class="nt">-in</span><span class="w"> </span><span class="nv">$FederatedCreds</span><span class="o">.</span><span class="nf">Subject</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Write-Verbose</span><span class="w"> </span><span class="s2">"Azure DevOps Federated Credentials have already been configured."</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$FederatedCredentialsParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
        </span><span class="nx">ApplicationObjectId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AppDetails</span><span class="err">.</span><span class="nx">Id</span><span class="w">
        </span><span class="nx">Issuer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdopsSC</span><span class="err">.</span><span class="nx">authorization</span><span class="err">.</span><span class="nx">parameters</span><span class="err">.</span><span class="nx">workloadIdentityFederationIssuer</span><span class="w">
        </span><span class="nx">Subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdopsSC</span><span class="err">.</span><span class="nx">authorization</span><span class="err">.</span><span class="nx">parameters</span><span class="err">.</span><span class="nx">workloadIdentityFederationSubject</span><span class="w">
        </span><span class="nx">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'AzureDevOpsAuthentication'</span><span class="w">
        </span><span class="nx">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Azure DevOps Federated Credentials"</span><span class="w">
        </span><span class="nx">Audience</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'api://AzureADTokenExchange'</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="n">New-AzADAppFederatedCredential</span><span class="w"> </span><span class="err">@</span><span class="nx">FederatedCredentialsParams</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Removes the default client secret</span><span class="w">
</span><span class="nv">$Secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzADAppCredential</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$AppDetails</span><span class="o">.</span><span class="nf">Id</span><span class="w">
</span><span class="nx">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$Secret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Remove-AzADAppCredential</span><span class="w"> </span><span class="nt">-KeyId</span><span class="w"> </span><span class="nv">$Secret</span><span class="o">.</span><span class="nf">KeyId</span><span class="w"> </span><span class="nt">-ApplicationId</span><span class="w"> </span><span class="nv">$AppDetails</span><span class="o">.</span><span class="nf">AppId</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Assigning correct permissions to Azure Landing Zone.</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">Get-AzRoleAssignment</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="s2">"/subscriptions/</span><span class="si">$(</span><span class="nv">$AzureLandingZone</span><span class="o">.</span><span class="nf">SubscriptionId</span><span class="si">)</span><span class="s2">"</span><span class="w"> </span><span class="nt">-RoleDefinitionName</span><span class="w"> </span><span class="nv">$RoleDefinitionName</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$App</span><span class="o">.</span><span class="nf">Id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">New-AzRoleAssignment</span><span class="w"> </span><span class="nt">-Scope</span><span class="w"> </span><span class="s2">"/subscriptions/</span><span class="si">$(</span><span class="nv">$AzureLandingZone</span><span class="o">.</span><span class="nf">SubscriptionId</span><span class="si">)</span><span class="s2">"</span><span class="w"> </span><span class="nt">-RoleDefinitionName</span><span class="w"> </span><span class="nv">$RoleDefinitionName</span><span class="w"> </span><span class="nt">-ObjectId</span><span class="w"> </span><span class="nv">$App</span><span class="o">.</span><span class="nf">Id</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">Write-Verbose</span><span class="w"> </span><span class="s2">"'</span><span class="si">$(</span><span class="nv">$App</span><span class="o">.</span><span class="nf">Id</span><span class="si">)</span><span class="s2">' already has access as '</span><span class="nv">$RoleDefinitionName</span><span class="s2">' over subscription '</span><span class="si">$(</span><span class="nv">$AzureLandingZone</span><span class="o">.</span><span class="nf">SubscriptionId</span><span class="si">)</span><span class="s2">'"</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Completes the Service connection authentication details in Azure DevOps</span><span class="w">
</span><span class="nv">$Params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">TenantId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$TenantId</span><span class="w">
    </span><span class="nx">SubscriptionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$subscriptionName</span><span class="w">
    </span><span class="nx">SubscriptionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$subscriptionId</span><span class="w">
    </span><span class="nx">Project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ProjectName</span><span class="w">
    </span><span class="nx">ServiceEndpointId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdopsSC</span><span class="err">.</span><span class="nx">Id</span><span class="w">
    </span><span class="nx">ConnectionName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdopsSC</span><span class="err">.</span><span class="nx">name</span><span class="w">
    </span><span class="nx">ServicePrincipalId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$App</span><span class="err">.</span><span class="nx">AppId</span><span class="w">
    </span><span class="nx">WorkloadIdentityFederationIssuer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdopsSC</span><span class="err">.</span><span class="nx">authorization</span><span class="err">.</span><span class="nx">parameters</span><span class="err">.</span><span class="nx">workloadIdentityFederationIssuer</span><span class="w">
    </span><span class="nx">WorkloadIdentityFederationSubject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$AdopsSC</span><span class="err">.</span><span class="nx">authorization</span><span class="err">.</span><span class="nx">parameters</span><span class="err">.</span><span class="nx">workloadIdentityFederationSubject</span><span class="w">
    </span><span class="nx">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Description</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">Set-ADOPSServiceConnection</span><span class="w"> </span><span class="err">@</span><span class="nx">Params</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-tip"><p>Do not forget to limit access to the service principal. If you intend to let non-platform engineers provision and create landing zones then perhaps a good option is to configure approval for the use of the service connection.</p></blockquote><h3 id="azure-devops-yml-example"><span class="mr-2">Azure DevOps .yml example</span><a href="#azure-devops-yml-example" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Once this is done, we can write our Azure DevOps pipeline. We will start with just creating our new Landing Zone and setting our prefered Management group.</p><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre><td class="rouge-code"><pre><span class="na">trigger</span><span class="pi">:</span> <span class="s">none</span>
  
<span class="na">variables</span><span class="pi">:</span> 
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">subscriptionCreationServiceConnection</span>
  <span class="na">value</span><span class="pi">:</span> <span class="s1">'</span><span class="s">SERVICECONNECTIONNAME'</span>

<span class="na">parameters</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Identifier</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">What is the identifying name of the Azure Landing Zone? (short name)</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">DisplayName</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">What is the display name of the Azure Landing Zone? (long name)</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ManagementGroupName</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Azure Management Group Name</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">BillingScope</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Azure Billing Scope, Example /billingAccounts/123456/enrollmentAccounts/123456</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Workload</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Azure Subscription Workload offer - https://azure.microsoft.com/en-us/pricing/offers/dev-test</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
  <span class="na">values</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="s">Production</span>
  <span class="pi">-</span> <span class="s">DevTest</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Environment</span>
  <span class="na">displayName</span><span class="pi">:</span> <span class="s">Environment?</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
  <span class="na">default</span><span class="pi">:</span> <span class="s">Sandbox</span>
  <span class="na">values</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">sbx</span>
  <span class="pi">-</span> <span class="s">dev</span>
  <span class="pi">-</span> <span class="s">acc</span>
  <span class="pi">-</span> <span class="s">prod</span>

<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">stage</span><span class="pi">:</span> <span class="s">provision</span>
    <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Subscription</span><span class="nv"> </span><span class="s">Vending'</span>
    <span class="na">jobs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">job</span><span class="pi">:</span> <span class="s">subscriptionCreate</span>
      <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Create</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Subscription'</span>
      <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">task</span><span class="pi">:</span> <span class="s">AzurePowerShell@5</span>
        <span class="na">displayName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">Create</span><span class="nv"> </span><span class="s">Azure</span><span class="nv"> </span><span class="s">Subscription'</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">CreateSub</span>
        <span class="na">inputs</span><span class="pi">:</span>
          <span class="na">azureSubscription</span><span class="pi">:</span> <span class="s">$(subscriptionCreationServiceConnection)</span>
          <span class="na">ScriptType</span><span class="pi">:</span> <span class="s1">'</span><span class="s">FilePath'</span>
          <span class="na">azurePowerShellVersion</span><span class="pi">:</span> <span class="s">LatestVersion</span>
          <span class="na">pwsh</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">ScriptPath</span><span class="pi">:</span> <span class="s1">'</span><span class="s">New-AzureSubscription.ps1'</span>
          <span class="na">ScriptArguments</span><span class="pi">:</span> <span class="pi">&gt;</span>
            <span class="s">-Identifier '$`\{`\{ parameters.Identifier `\}}'</span>
            <span class="s">-BillingScope '$`\'</span>
            <span class="s">-Workload 'Production'</span>
            <span class="s">-ManagementGroupId '/providers/Microsoft.Management/managementGroups/${`\{ parameters.ManagementGroupName }}'</span>
            <span class="s">-EnvironmentShortName '$(variableOutput.environmentShortName)'</span>
            <span class="s">-DisplayName '$'</span>
</pre></table></code></div></div><p>After importing and running the Azure DevOps pipeline, the output should simply look like this: <a href="/assets/images/2024/10/DevOpsSubscriptionStatus.png" class="popup img-link "><img data-src="/assets/images/2024/10/DevOpsSubscriptionStatus.png" alt="result" class="lazyload" data-proofer-ignore></a></p><p>Now we can add more steps to the pipeline according to our needs.</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We have now established a workload identity with federated credentials to provision our Azure Subscriptions. We have also created the nessecary automation &amp; Azure DevOps pipeline to provide a basic self-service feature for our colleagues.</p><p>We can continue to add steps to our subscription vending, for example incorporating the orchestration of Entra Id security groups, privileged access management, entitlement management, IP address management, critical infrastructure resources such as peering to hub network, budgets, service health alerts and so on.</p><p><em>References;</em></p><ul><li><a href="https://learn.microsoft.com/en-us/azure/architecture/landing-zones/subscription-vending"><em>Subscription vending implementation guidance</em></a><li><a href="https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/landing-zone/design-area/subscription-vending"><em>Subscription vending</em></a><li><a href="https://devblogs.microsoft.com/devops/workload-identity-federation-for-azure-deployments-is-now-generally-available"><em>Azure devops workload identity federation</em></a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/azure/'>Azure</a>, <a href='/categories/subscription-vending/'>Subscription vending</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/sebastian/" class="post-tag no-text-decoration" >sebastian</a> <a href="/tags/claesson/" class="post-tag no-text-decoration" >claesson</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a> <a href="/tags/subscription/" class="post-tag no-text-decoration" >subscription</a> <a href="/tags/landing-zone/" class="post-tag no-text-decoration" >landing zone</a> <a href="/tags/vending/" class="post-tag no-text-decoration" >vending</a> <a href="/tags/machine/" class="post-tag no-text-decoration" >machine</a> <a href="/tags/vendingmachine/" class="post-tag no-text-decoration" >vendingmachine</a> <a href="/tags/automation/" class="post-tag no-text-decoration" >automation</a> <a href="/tags/permissions/" class="post-tag no-text-decoration" >permissions</a> <a href="/tags/ea/" class="post-tag no-text-decoration" >ea</a> <a href="/tags/mca/" class="post-tag no-text-decoration" >mca</a> <a href="/tags/rest/" class="post-tag no-text-decoration" >rest</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Subscription%20Vending%20-%20Sebastian%20Claesson&url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FSubscriptionVending%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Subscription%20Vending%20-%20Sebastian%20Claesson&u=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FSubscriptionVending%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FSubscriptionVending%2F&text=Subscription%20Vending%20-%20Sebastian%20Claesson" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SubscriptionVending/">Subscription Vending</a><li><a href="/posts/AzureDevOpsColoredOutput/">Azure DevOps Pipeline Output</a><li><a href="/posts/AzureDevOpsExtension-Linux/">Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</a><li><a href="/posts/AzureCrossTenantCollaboration/">Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</a><li><a href="/posts/AzureFunctions/">PowerShell Azure Function - Managed identity & triggers/bindings</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AzureDevOpsExtension-Linux/"><div class="card-body"> <em class="small" data-ts="1667912100" data-df="ll" > Nov 8, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</h3><div class="text-muted small"><p> Are you looking to run your Azure DevOps agent behind an unauthenticated/authenticated web proxy for traffic destined to the internet? Then hopefully this post will help you straighten out those q...</p></div></div></a></div><div class="card"> <a href="/posts/AzureFunctions/"><div class="card-body"> <em class="small" data-ts="1660229700" data-df="ll" > Aug 11, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PowerShell Azure Function - Managed identity & triggers/bindings</h3><div class="text-muted small"><p> I’ve been playing around a little with Azure Functions and Azure Alerting. The design was to be able to utilize the Azure Alert rule processing function in Azure and have it create a prettier mail ...</p></div></div></a></div><div class="card"> <a href="/posts/AzureCrossTenantCollaboration/"><div class="card-body"> <em class="small" data-ts="1680526500" data-df="ll" > Apr 3, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</h3><div class="text-muted small"><p> The possibility to create Virtual network peerings across Azure Active Directory tenants has been available since 2018. It’s a feature which is allowed by default and is quite easy to setup and ge...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AzureCrossTenantCollaboration/" class="btn btn-outline-primary" prompt="Older"><p>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</p></a> <a href="/posts/NordicIntegrationSummit/" class="btn btn-outline-primary" prompt="Newer"><p>Nordic Integration Summit</p></a></div><script src="https://utteranc.es/client.js" repo="SebastianClaesson/sebastianclaesson.github.io" issue-term="pathname" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/SebClaesson">Sebastian Claesson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LQDR23C4VN"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LQDR23C4VN'); }); </script>
