<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="PowerShell Azure Function - Managed identity &amp; triggers/bindings" /><meta property="og:locale" content="en" /><meta name="description" content="I’ve been playing around a little with Azure Functions and Azure Alerting. The design was to be able to utilize the Azure Alert rule processing function in Azure and have it create a prettier mail than what comes out of box." /><meta property="og:description" content="I’ve been playing around a little with Azure Functions and Azure Alerting. The design was to be able to utilize the Azure Alert rule processing function in Azure and have it create a prettier mail than what comes out of box." /><link rel="canonical" href="https://blog.sebastianclaesson.se/posts/AzureFunctions/" /><meta property="og:url" content="https://blog.sebastianclaesson.se/posts/AzureFunctions/" /><meta property="og:site_name" content="Sebastian Claesson" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-11T16:55:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="PowerShell Azure Function - Managed identity &amp; triggers/bindings" /><meta name="twitter:site" content="@SebClaesson" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-11-11T09:11:19+01:00","datePublished":"2022-08-11T16:55:00+02:00","description":"I’ve been playing around a little with Azure Functions and Azure Alerting. The design was to be able to utilize the Azure Alert rule processing function in Azure and have it create a prettier mail than what comes out of box.","headline":"PowerShell Azure Function - Managed identity &amp; triggers/bindings","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sebastianclaesson.se/posts/AzureFunctions/"},"url":"https://blog.sebastianclaesson.se/posts/AzureFunctions/"}</script><title>PowerShell Azure Function - Managed identity & triggers/bindings | Sebastian Claesson</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sebastian Claesson"><meta name="application-name" content="Sebastian Claesson"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/images/ps_black_128.svg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sebastian Claesson</a></div><div class="site-subtitle font-italic">Techblog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/SebastianClaesson" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/SebClaesson" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sebastianclaesson','hotmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>PowerShell Azure Function - Managed identity & triggers/bindings</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>PowerShell Azure Function - Managed identity & triggers/bindings</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1660229700" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 11, 2022 </em> </span> <span> Updated <em class="" data-ts="1668154279" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 11, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/SebClaesson">Sebastian Claesson</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1338 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>I’ve been playing around a little with Azure Functions and Azure Alerting. The design was to be able to utilize the Azure Alert rule processing function in Azure and have it create a prettier mail than what comes out of box.</p><p>Basically the design boiled down to having a few Azure Functions running a bit of PowerShell and a storage account with some tables and queues.</p><p>First of all we’ll need a Function app with a managed identity. For this project I’ve decided to use a System Assigned identity for my Function app.</p><p>I’ll deploy a bicep with the following settings to my Function app:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre>var location = resourceGroup().location

resource storageAccount 'Microsoft.Storage/storageAccounts@2021-09-01' = {
  name: 'stalertdemo'
  kind: 'StorageV2'
  location: location
  sku: {
    name: 'Standard_LRS'
  }
  properties: {
    allowBlobPublicAccess: false
    allowSharedKeyAccess: true
    accessTier: 'Hot'
    supportsHttpsTrafficOnly: true
  }
}

resource queueService 'Microsoft.Storage/storageAccounts/queueServices@2021-09-01' = {
  name: 'default'
  parent: storageAccount
}

resource sendgrid 'Microsoft.Storage/storageAccounts/queueServices/queues@2021-09-01' = {
  name: 'sendgrid'
  parent: queueService
}

resource tableService 'Microsoft.Storage/storageAccounts/tableServices@2021-09-01' = {
  name: 'default'
  parent: storageAccount
}

resource keyvault 'Microsoft.KeyVault/vaults@2021-10-01' = {
  name: 'alertdemo-kv'
  location: location
  properties: {
    enabledForDeployment: false
    enabledForDiskEncryption: false
    enabledForTemplateDeployment: false
    enableRbacAuthorization: true
    enableSoftDelete: false
    tenantId: subscription().tenantId
    sku: {
      name: 'standard'
      family: 'A'
    }
  }
}

resource appServicePlan 'Microsoft.Web/serverfarms@2020-12-01' = {
  name: 'alertdemo-plan'
  location: location
  sku: {
    tier: 'Dynamic'
    name: 'Y1'
  }
}

resource functionApp 'Microsoft.Web/sites@2022-03-01' = {
  name: 'alertdemo-app'
  location: location
  kind: 'functionapp'
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    serverFarmId: appServicePlan.id
    httpsOnly: true
    clientAffinityEnabled: false
    siteConfig: {
      cors: {
        allowedOrigins: [
          'https://azure.portal.com'
        ]
      }
      powerShellVersion: '7.2'
      netFrameworkVersion: 'v6.0'
      ftpsState: 'Disabled'
    }
  }
}

resource functionAppSettings 'Microsoft.Web/sites/config@2020-06-01' = {
  parent: functionApp
  name: 'appsettings'
  properties: {
    AzureWebJobsDisableHomepage: 'true'
    AzureWebJobsSecretStorageKeyVaultUri: keyvault.properties.vaultUri
    AzureWebJobsSecretStorageType: 'keyvault'
    AzureWebJobsStorage__accountName: storageAccount.name
    FUNCTIONS_APP_EDIT_MODE: 'readonly'
    StorageQueueConnection__credential: 'managedidentity'
    StorageQueueConnection__queueServiceUri: storageAccount.properties.primaryEndpoints.queue
    WEBSITE_RUN_FROM_PACKAGE: '1'
    FUNCTIONS_WORKER_RUNTIME: 'powershell'
    FUNCTIONS_EXTENSION_VERSION: '~4'
  }
}
</pre></table></code></div></div><p>The bicep file will now create/configure:</p><ol><li>Create a Azure Storage Account with queue and table services enabled.<li>Create a queue called sendgrid<li>Store secrets in keyvault (such as the master/function keys) using the managed identity.<li>Create a StorageQueueConnection object that will use my Storage Accounts queue endpoint and connect to that using the managed identity.</ol><blockquote class="prompt-info"><p>The bicep file is not complete and is missing resources such as role assignments etc. This just a demonstration of how to set the application settings.</p></blockquote><p>Once the infrastructure is in place, you can now create the structure for your function app. If you’re familiar with zip deployments/function bindings, this will be easy. However, if you are not familiar with it, I suggest reading about it at <a href="https://docs.microsoft.com/en-us/azure/azure-functions/deployment-zip-push">Zip-deploy</a> &amp; <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings?tabs=powershell">Function Triggers and Bindings</a>.</p><p><strong><em>Brief explaination of the triggers/bindings.</em></strong></p><p><em>You can specify both in- and output bindings. There’s bindings that you can use from the open source community or included in the function runtime. Read more about the runtime <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-register#extension-bundles">extension bundle</a>.</em></p><p>In my scenario, I’ll create a input binding that uses the Azure Storage Queue trigger. For my function it will have a function.json in it’s folder, containing the following configuration:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"bindings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"QueueItem"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"queueTrigger"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"queueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sendgrid"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"connection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StorageQueueConnection"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>As you can see there’s a queueTrigger binding called “QueueItem”.</p><p>It also has a queueName which is the name of the queue, and a connection.</p><p>The binding will use the StorageQueueConnection “object” specified in my function app settings to retrieve the connection, as we specified in the bicep template.</p><p>The “object” can contain several settings, which you can read more about here <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference?tabs=blob#common-properties-for-identity-based-connections">Common properties for identity based connections</a> &amp; <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference?tabs=blob#connecting-to-host-storage-with-an-identity-preview">Connecting to host storage with an identity (Preview)</a>.</p><p>As you can see, I have no App Setting called “StorageQueueConnection”, however I do have the following app settings:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>    StorageQueueConnection__credential: 'managedidentity'
    StorageQueueConnection__queueServiceUri: storageAccount.properties.primaryEndpoints.queue
</pre></table></code></div></div><p>Together these app settings form the connection object. When the runtime is running a sync cycle, it will try and parse my settings that is prefixed with “StorageQueueConnection” and followed by two underscores. In my case, it will try to connect to my Azure Storage Account Queue endpoint using the Function app managed identity.</p><blockquote class="prompt-info"><p>In order for this to work, you’ll have to make sure that the managed identity has at least the Storage Queue Data Contributor role.</p></blockquote><p>The configuration for the Azure Storage Account Queue settings can be set in the host.json file for the Function app. For our Function app, we’ll use the following configuration:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"extensionBundle"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.Azure.Functions.ExtensionBundle"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[3.11.0, 4.0.0)"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"extensions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"queues"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"maxPollingInterval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00:00:02"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"visibilityTimeout"</span><span class="p">:</span><span class="w"> </span><span class="s2">"00:00:30"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"batchSize"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nl">"maxDequeueCount"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nl">"newBatchThreshold"</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">
      </span><span class="nl">"messageEncoding"</span><span class="p">:</span><span class="w"> </span><span class="s2">"base64"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>This will configure our app to check the queue every 2 second. More about this can be found here <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-queue?tabs=in-process%2Cextensionv5%2Cextensionv3&amp;pivots=programming-language-powershell">queue extension settings</a>.</p><p>After adding some PowerShell magic to our function app it will now parse the data passed down by the queue to the function.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kr">using</span><span class="w"> </span><span class="kr">namespace</span><span class="w"> </span><span class="n">System.Net</span><span class="w">
</span><span class="c"># Input bindings are passed in via param block.</span><span class="w">
</span><span class="kr">param</span><span class="p">(</span><span class="nv">$QueueItem</span><span class="p">,</span><span class="w"> </span><span class="nv">$TriggerMetadata</span><span class="p">)</span><span class="w">
</span><span class="n">Write-Information</span><span class="w"> </span><span class="s2">"Queue item insertion time: </span><span class="si">$(</span><span class="nv">$TriggerMetadata</span><span class="o">.</span><span class="nf">InsertionTime</span><span class="si">)</span><span class="s2">"</span><span class="w">
</span><span class="n">Write-Information</span><span class="w"> </span><span class="nv">$QueueItem</span><span class="w">
</span></pre></table></code></div></div><blockquote class="prompt-info"><p>The parameter must match the name set in the function.json file, in our case ‘QueueItem’</p></blockquote><p>This PowerShell script will only output the insertion time and the data of the message found in the queue.</p><p>We will make it more interesting in our case, and add a new output binding for SendGrid. To enable the output binding for SendGrid we will have to go back to our function.json file and add the following rows:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"bindings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"QueueItem"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"queueTrigger"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"in"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"queueName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sendgrid"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"connection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"StorageQueueConnection"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sendGrid"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"out"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"apikey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;input api key&gt;"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Now as you can see, we have added a new output binding of the type sendGrid in the out direction. We’ll give it the name message.</p><p>To understand how the sendGrid output binding works, we can read the help docs at <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-sendgrid?tabs=in-process%2Cfunctionsv2&amp;pivots=programming-language-powershell#configuration">SendGrid configuration</a>.</p><blockquote class="prompt-info"><p>To get your API key and getting started with SendGrid, you can read more here: <a href="https://www.twilio.com/blog/send-emails-csharp-dotnet-with-azure-functions-and-sendgrid-bindings">SendGrid - Getting started</a>.</p></blockquote><blockquote class="prompt-tip"><p>I strongly suggest that you keep this secret inside of an Azure Keyvault and have a reference to it inside your function app setting.</p></blockquote><p>But to keep it short, we’ll add the following code to our PowerShell script.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nv">$mail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="s2">"personalizations"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
        </span><span class="p">@{</span><span class="w">
            </span><span class="s2">"to"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Collections.ArrayList</span><span class="p">]@(@{</span><span class="s2">"email"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"user@contoso.com"</span><span class="p">})</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="s2">"from"</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w"> 
        </span><span class="s2">"email"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"user@contoso.com"</span><span class="w">
    </span><span class="p">}</span><span class="w">        
    </span><span class="s2">"subject"</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="s2">"New message!"</span><span class="w">
    </span><span class="s2">"content"</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
        </span><span class="p">@{</span><span class="w">
            </span><span class="s2">"type"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"text"</span><span class="w">
            </span><span class="s2">"value"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"A new message was put on the queue!"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c"># Send the email using the output binding for SendGrid.</span><span class="w">
</span><span class="n">Push-OutputBinding</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-Json</span><span class="w"> </span><span class="nt">-InputObject</span><span class="w"> </span><span class="nv">$mail</span><span class="w"> </span><span class="nt">-Depth</span><span class="w"> </span><span class="nx">100</span><span class="p">)</span><span class="w"> 
</span></pre></table></code></div></div><p>Now the output binding will try to send an api call to SendGrid with our message. The simple message will look like this:</p><p><a href="/assets/images/2022/2022-08-16-1.png" class="popup img-link "><img data-src="/assets/images/2022/2022-08-16-1.png" alt="simple-mail" class="lazyload" data-proofer-ignore></a></p><p>To make it more advanced you can also send a html file, in my case I’ll use a html template file with some placeholders which we’ll search and replace during runtime and using the information passed down by the message. Simply change the change the content-type to “text/html” when posting to the output binding, if you like pretty mails :)</p><p><a href="/assets/images/2022/2022-08-16-2.png" class="popup img-link "><img data-src="/assets/images/2022/2022-08-16-2.png" alt="html-mail" class="lazyload" data-proofer-ignore></a></p><p>Thank you for reading and hopefully my notes will be found useful!</p><p>//Sebastian</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/azure/'>Azure</a>, <a href='/categories/functionapp/'>FunctionApp</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a> <a href="/tags/alert/" class="post-tag no-text-decoration" >alert</a> <a href="/tags/queue/" class="post-tag no-text-decoration" >queue</a> <a href="/tags/table/" class="post-tag no-text-decoration" >table</a> <a href="/tags/identity/" class="post-tag no-text-decoration" >identity</a> <a href="/tags/managed-identity/" class="post-tag no-text-decoration" >managed identity</a> <a href="/tags/function/" class="post-tag no-text-decoration" >function</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=PowerShell%20Azure%20Function%20-%20Managed%20identity%20&%20triggers/bindings%20-%20Sebastian%20Claesson&url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureFunctions%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=PowerShell%20Azure%20Function%20-%20Managed%20identity%20&%20triggers/bindings%20-%20Sebastian%20Claesson&u=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureFunctions%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureFunctions%2F&text=PowerShell%20Azure%20Function%20-%20Managed%20identity%20&%20triggers/bindings%20-%20Sebastian%20Claesson" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SubscriptionVending/">Subscription Vending</a><li><a href="/posts/AzureDevOpsColoredOutput/">Azure DevOps Pipeline Output</a><li><a href="/posts/AzureDevOpsExtension-Linux/">Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</a><li><a href="/posts/AzureCrossTenantCollaboration/">Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</a><li><a href="/posts/AzureFunctions/">PowerShell Azure Function - Managed identity & triggers/bindings</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AzureDevOpsExtension-Linux/"><div class="card-body"> <em class="small" data-ts="1667912100" data-df="ll" > Nov 8, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</h3><div class="text-muted small"><p> Are you looking to run your Azure DevOps agent behind an unauthenticated/authenticated web proxy for traffic destined to the internet? Then hopefully this post will help you straighten out those q...</p></div></div></a></div><div class="card"> <a href="/posts/AzureCrossTenantCollaboration/"><div class="card-body"> <em class="small" data-ts="1680526500" data-df="ll" > Apr 3, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</h3><div class="text-muted small"><p> The possibility to create Virtual network peerings across Azure Active Directory tenants has been available since 2018. It’s a feature which is allowed by default and is quite easy to setup and ge...</p></div></div></a></div><div class="card"> <a href="/posts/SubscriptionVending/"><div class="card-body"> <em class="small" data-ts="1728176100" data-df="ll" > Oct 6, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Subscription Vending</h3><div class="text-muted small"><p> Introduction An important part of Azure Landing Zones is the ability to create Azure subscriptions (landing zones) through automation. Any scripts and code used in this post can be found at: ht...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"><div class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></div><a href="/posts/AzureDevOpsColoredOutput/" class="btn btn-outline-primary" prompt="Newer"><p>Azure DevOps Pipeline Output</p></a></div><script src="https://utteranc.es/client.js" repo="SebastianClaesson/sebastianclaesson.github.io" issue-term="pathname" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/SebClaesson">Sebastian Claesson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LQDR23C4VN"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LQDR23C4VN'); }); </script>
