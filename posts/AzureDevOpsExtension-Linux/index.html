<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy." /><meta name="author" content="Sebastian Claesson" /><meta property="og:locale" content="en" /><meta name="description" content="Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy." /><meta property="og:description" content="Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy." /><link rel="canonical" href="https://blog.sebastianclaesson.se/posts/AzureDevOpsExtension-Linux/" /><meta property="og:url" content="https://blog.sebastianclaesson.se/posts/AzureDevOpsExtension-Linux/" /><meta property="og:site_name" content="Sebastian Claesson" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-11-08T13:55:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy." /><meta name="twitter:site" content="@SebClaesson" /><meta name="twitter:creator" content="@Sebastian Claesson" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sebastian Claesson"},"dateModified":"2024-10-06T10:32:00+02:00","datePublished":"2022-11-08T13:55:00+01:00","description":"Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.","headline":"Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.sebastianclaesson.se/posts/AzureDevOpsExtension-Linux/"},"url":"https://blog.sebastianclaesson.se/posts/AzureDevOpsExtension-Linux/"}</script><title>Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy. | Sebastian Claesson</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Sebastian Claesson"><meta name="application-name" content="Sebastian Claesson"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/images/ps_black_128.svg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Sebastian Claesson</a></div><div class="site-subtitle font-italic">Techblog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/SebastianClaesson" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/SebClaesson" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['sebastianclaesson','hotmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1667912100" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 8, 2022 </em> </span> <span> Updated <em class="" data-ts="1728203520" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 6, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href=""></a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2183 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><p>Are you looking to run your Azure DevOps agent behind an unauthenticated/authenticated web proxy for traffic destined to the internet?</p><p>Then hopefully this post will help you straighten out those question marks that might come up during the process. There’s a bit of a difference between the Windows and Linux agent, this post will only cover the Linux agent running on Ubuntu 20.04, one for the Windows Agent is on it’s way.</p><p>We’ll start first with a summary of how the installation and deployment of the Azure DevOps VM Extension works, this will help us get an insight of what steps in the process where issues might occur.</p><ol><li>VM/VMSS has the Azure DevOps Extension deployed to it, using the portal, cli or infrastructure-as-code.<li>The VM/VMSS will download the extension in a compressed format (zip) from a public Azure Storage Account.<li>The Extension will run the “Handler.sh -enable” command and run either AzureRM.py or AzureRM_Python2.py (depending on what Python version is available) to install the DevOps Agent.<li>AzureRM.py (or AzureRM_Python2.py) will read the settings file (containing the Public and Protected Settings), decrypt the protected settings with the computer certificate available and remove it from the settings file.<li>AzureRM.py will download the Azure DevOps agent zip file and EnableAgent script specified in the Public settings.<li>The InstallDependecies.sh script will use APT to install missing dependencies.<li>The Azure DevOps agent installation will start and configure itself according to the scenario specified.</ol><p>The log locations for the Azure DevOps VM Extension are:</p><ul><li>/var/log/azure/Microsoft.VisualStudio.Services.TeamServicesAgentLinux<li>/agent directory/_diag (The value for the directory per default is “agent”)</ul><blockquote class="prompt-info"><p>Read more about the communication and setup of <a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/agents?view=azure-devops&amp;tabs=browser">Azure DevOps Agent</a></p></blockquote><p>As part of our network design, it is decided that no web traffic may go directly to the internet destination, instead it will always go through a proxy.</p><p>If the traffic tries to reach it’s destination without going through the proxy, the network security group (NSG) will stop it. However the NSG will not interrupt web traffic within the virtual network.</p><blockquote class="prompt-info"><p>I highely suggest that you use the <a href="https://azuremarketplace.microsoft.com/en-us/marketplace/apps/cloud-infrastructure-services.squid-ubuntu-2004?tab=Overview">Squid Proxy Server</a> in Azure Marketplace to experiment with, Note that the product has an hourly cost.</p></blockquote><p>The first thing we will have to do is to create the Bicep template.</p><details> <summary>VMSS Bicep Template Example</summary><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
</pre><td class="rouge-code"><pre>var location = resourceGroup().location
var AzureDevOpsPATToken = 'AzureDevOpsPATToken'
var subnetId = '/subscriptions/81bee834-3e8e-4f5d-bb31-3316a05e5583/resourceGroups/demo-rg/providers/Microsoft.Network/virtualNetworks/demo-vnet/subnets/demo-snet'

resource vmss 'Microsoft.Compute/virtualMachineScaleSets@2022-03-01' = {
  name: 'demo-vmss'
  location: location
  identity: {
    type: 'SystemAssigned'
  }
  sku: {
    capacity: 1
    name: 'Standard_B2ms'
  }
  properties: {
    overprovision: false
    upgradePolicy: {
      mode: 'Manual'
    }
    singlePlacementGroup: false
    virtualMachineProfile: {
      storageProfile: {
        osDisk: {
          createOption: 'FromImage'
        }
        imageReference: {
          publisher: 'canonical'
          offer: '0001-com-ubuntu-server-focal'
          sku: '20_04-lts-gen2'
          version: 'latest'
        }
      }
      osProfile: {
        adminPassword: 'DemoTest123'
        adminUsername: 'demouser'
        computerNamePrefix: 'demo'
      }
      networkProfile: {
        networkInterfaceConfigurations: [
          {
            name: 'demo-vmss-nic'
            properties: {
              primary: true
              enableAcceleratedNetworking: false
              ipConfigurations: [
                {
                  name: 'demo-vmss-nic-ipc'
                  properties: {
                    primary: true
                    subnet: {
                      id: subnetId
                    }
                  }
                }
              ]
            }
          }
        ]
      }
      extensionProfile: {
        extensions:[
          {
            name: 'Microsoft.Azure.DevOps.Pipelines.Agent'
            properties: {
                autoUpgradeMinorVersion: false
                publisher: 'Microsoft.VisualStudio.Services'
                type: 'TeamServicesAgentLinux'
                typeHandlerVersion: '1.23'
                settings: {
                    isPipelinesAgent: true
                    agentFolder: '/agent'
                    AzureDevOpsOrganizationUrl: 'https://dev.azure.com/sebcla'
                    TeamProject: 'Demo'
                    enableScriptParameters: 'https://dev.azure.com/sebcla AgentPoolName ${AzureDevOpsPATToken}'
                    agentDownloadUrl: 'https://vstsagentpackage.azureedge.net/agent/2.211.1/vsts-agent-linux-x64-2.211.1.tar.gz'
                    enableScriptDownloadUrl: 'https://vstsagenttools.blob.core.windows.net/tools/ElasticPools/Linux/14/enableagent.sh'
                }
                protectedSettings: {
                  PATToken: AzureDevOpsPATToken
                }
            }
        }
        ]
      }
    }
  }
}
</pre></table></code></div></div></details><p><br /></p><blockquote class="prompt-info"><p>Currently rouge do not support Bicep syntax highlighting. If you would like to see Bicep hightlighting, then please up-vote <a href="https://github.com/rouge-ruby/rouge/issues/1887">Rouge Bicep Hightlighting</a> at GitHub.</p></blockquote><blockquote class="prompt-info"><p>Note that in the example ARM file a Personal Access Token (PAT) is used under the protected settings. You should never share your PAT with anyone and always keep it protected, therefor it is not a good practice to use the PAT in clear text of your deployment. Please make sure you only issue short-lived tokens if you are to use them in clear text or use a keyvault reference. Read more about that here: <a href="https://learn.microsoft.com/en-us/azure/templates/microsoft.compute/virtualmachines/extensions?pivots=deployment-language-bicep#keyvaultsecretreference">Microsoft.Compute/virtualMachines/extensions</a></p></blockquote><p>The first issue we will encounter is that the Azure DevOps Extension will fail it’s installation.</p><p>This is because the Azure DevOps VM Extension cannot be downloaded as it is hosted on Microsoft generated storage accounts.</p><p>In my case the url was: https://umsaqts1kdw3dgdrdmzt.blob.core.windows.net/76d90c30-c607-43bc-49aa-02e322a01e7b/76d92c30-c607-43bc-49aa-32e322a01e7b_1.22.0.0.zip</p><p>If you want to see more details about the VM Extension logs, you can find them at /var/log/azure/Microsoft.VisualStudio.Services.TeamServicesAgentLinux/CommandExecution.log</p><p><em>Example log of a successful download:</em></p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>2022-11-04T08:55:06.150100Z INFO ExtHandler [Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0] Target handler state: enabled [incarnation_1]
2022-11-04T08:55:06.150369Z INFO ExtHandler [Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0] [Enable] current handler state is: notinstalled
2022-11-04T08:55:06.150627Z INFO ExtHandler [Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0] Downloading extension package: https://umsaqts1kdw3dgdrdmzt.blob.core.windows.net/76d90c30-c607-43bc-49aa-02e322a01e7b/76d92c30-c607-43bc-49aa-32e322a01e7b_1.22.0.0.zip
2022-11-04T08:55:06.187235Z INFO ExtHandler [Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0] Unzipping extension package: /var/lib/waagent/Microsoft.VisualStudio.Services.TeamServicesAgentLinux__1.22.0.0.zip
2022-11-04T08:55:06.191683Z INFO ExtHandler [Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0] Initializing extension Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0
2022-11-04T08:55:06.192513Z INFO ExtHandler [Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0] Update settings file: 266.settings
2022-11-04T08:55:06.192717Z INFO ExtHandler [Microsoft.VisualStudio.Services.TeamServicesAgentLinux-1.22.0.0] Install extension [Handler.sh]
</pre></table></code></div></div><blockquote class="prompt-info"><p>As you can see in the logs, this is where the settings file is generated. We will go deeper into the settings file, what it is used for and when further down.</p></blockquote><p>Once you have allowed the Azure DevOps VM extension to download itself, then the next problem will be that the Azure DevOps VM Extension itself is not proxy aware and fail when trying to download the agent zip and enable agent script.</p><p>Looking at the code for the Azure DevOps Extension, we can see on row 596 in the AzureRM.py that it will try to run the command: “Util.url_retrieve(downloadUrl, agentFile)”.</p><p>The downloadUrl and agentFile is defined in the VM Extension part of your scale-set.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>{
    name: 'Microsoft.Azure.DevOps.Pipelines.Agent'
    properties: {
        autoUpgradeMinorVersion: false
        publisher: 'Microsoft.VisualStudio.Services'
        type: 'TeamServicesAgentLinux'
        typeHandlerVersion: '1.22'
        settings: {
            isPipelinesAgent: true
            agentFolder: '/agent'
            AzureDevOpsOrganizationUrl: 'https://dev.azure.com/sebcla'
            TeamProject: 'Demo'
            enableScriptParameters: 'https://dev.azure.com/sebcla AgentPoolName ${AzureDevOpsPATToken}'
            agentDownloadUrl: 'https://vstsagentpackage.azureedge.net/agent/2.211.1/vsts-agent-linux-x64-2.211.1.tar.gz'
            enableScriptDownloadUrl: 'https://vstsagenttools.blob.core.windows.net/tools/ElasticPools/Linux/14/enableagent.sh'
        }
        protectedSettings: {
          PATToken: AzureDevOpsPATToken
        }
    }
}
</pre></table></code></div></div><p>The Util library is imported from the Utils/HandlerUtil.py module.</p><p>The url_retrieve function contains the following bit of code:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">url_retrieve</span><span class="p">(</span><span class="n">download_url</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
  <span class="nf">if </span><span class="p">(</span><span class="sh">'</span><span class="s">ProxyUrl</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">proxy_config</span><span class="p">):</span>
    <span class="n">proxy_url</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="p">[</span><span class="sh">'</span><span class="s">ProxyUrl</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">proxy_handler</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nc">ProxyHandler</span><span class="p">({</span><span class="sh">'</span><span class="s">https</span><span class="sh">'</span><span class="p">:</span> <span class="n">proxy_url</span><span class="p">})</span>
    <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">build_opener</span><span class="p">(</span><span class="n">proxy_handler</span><span class="p">)</span>
    <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">install_opener</span><span class="p">(</span><span class="n">opener</span>
  <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlretrieve</span><span class="p">(</span><span class="n">download_url</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
</pre></table></code></div></div><p>Which suggests that the function should be retreiving the proxy settings, if ProxyUrl is defined in “proxy_config”.</p><p>Going back to the AzureRM.py script, we can see that the proxy_config is imported as ‘from Utils.GlobalSettings import proxy_config’.</p><p>Reading the GlobalSettings.py file we can see that it contains the following:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">proxy_config</span> <span class="o">=</span> <span class="p">{}</span>
</pre></table></code></div></div><p>However, there is no function where this file gets populated on the fly depending on for example the machine variables http_proxy/https_proxy etc.</p><blockquote class="prompt-info"><p>Looking at the urllib documentation <a href="https://docs.python.org/3/library/urllib.request.html">urllib docs</a> we can see that it supports a function of getting the proxy settings “request.getproxies()”, but as part of the code it is not implemented.</p></blockquote><p>As we cannot make the Extension understand that it should use a proxy, we can edit the path for agentDownloadUrl and enableScriptDownloadUrl to be hosted on a Azure Storage Account with a private endpoint in the same virtual network as the VMSS.</p><p>This will allow the Azure DevOps Extension to download these files without a web proxy. As we are allowed to send web traffic within our virtual network without having the traffic dropped.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>{
    name: 'Microsoft.Azure.DevOps.Pipelines.Agent'
    properties: {
        autoUpgradeMinorVersion: false
        publisher: 'Microsoft.VisualStudio.Services'
        type: 'TeamServicesAgentLinux'
        typeHandlerVersion: '1.22'
        settings: {
            isPipelinesAgent: true
            agentFolder: '/agent'
            AzureDevOpsOrganizationUrl: 'https://dev.azure.com/sebcla'
            TeamProject: 'Demo'
            enableScriptParameters: 'https://dev.azure.com/sebcla AgentPoolName ${AzureDevOpsPATToken}'
            agentDownloadUrl: 'https://internaltestfeed.blob.core.windows.net/devops/vsts-agent-linux-x64-2.211.1.tar.gz'
            enableScriptDownloadUrl: 'https://internaltestfeed.blob.core.windows.net/devops/enableagent.sh'
        }
        protectedSettings: {
          PATToken: AzureDevOpsPATToken
        }
    }
}
</pre></table></code></div></div><p>Once you have successfully updated the extension settings, you can now read the log file @ /agent/_diag/Agent_timestamp-utc.log which contains the following rows that identifies that we have set the proxy correctly.</p><p><em>Correct setup</em></p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>[2022-11-04 08:23:39Z INFO AgentProcess] Arguments parsed
[2022-11-04 08:23:39Z INFO HostContext] Well known directory 'Bin': '/agent/bin'
[2022-11-04 08:23:39Z INFO HostContext] Well known directory 'Root': '/agent'
[2022-11-04 08:23:39Z INFO HostContext] Well known config file 'Proxy': '/agent/.proxy'
[2022-11-04 08:23:39Z INFO VstsAgentWebProxy] Config proxy at: http://10.2.0.7:3128.
[2022-11-04 08:23:39Z INFO HostContext] Well known directory 'Bin': '/agent/bin'
[2022-11-04 08:23:39Z INFO HostContext] Well known directory 'Root': '/agent'
[2022-11-04 08:23:39Z INFO HostContext] Well known config file 'ProxyCredentials': '/agent/.proxycredentials'
[2022-11-04 08:23:39Z INFO VstsAgentWebProxy] Config proxy use DefaultNetworkCredentials.
</pre></table></code></div></div><p><em>If the string is not a correct formated string (https/http://proxyaddress:port)</em></p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>[2022-11-04 07:48:33Z INFO AgentProcess] Arguments parsed
[2022-11-04 07:48:33Z INFO HostContext] Well known directory 'Bin': '/agent/bin'
[2022-11-04 07:48:33Z INFO HostContext] Well known directory 'Root': '/agent'
[2022-11-04 07:48:33Z INFO HostContext] Well known config file 'Proxy': '/agent/.proxy'
[2022-11-04 07:48:33Z ERR  VstsAgentWebProxy] The proxy url is not a well formed absolute uri string: 10.2.0.7:3128.
[2022-11-04 07:48:33Z INFO VstsAgentWebProxy] No proxy setting found.
</pre></table></code></div></div><p>Now the Azure DevOps agent can report back to Azure DevOps using the web proxy!</p><p>Maybe now you have started to wonder - <em>I have issued an Azure DevOps token, where and how is it stored?</em></p><p>Well, to be honest I have not yet figured exactly how it works, but I’ve noticed that the token is used to issue a JWT towards Azure DevOps.</p><p>The JWT issued is only valid for a short time and can be used to report back as a healthy agent to Azure DevOps.</p><p>The settings file (containing your JWT and other settings) will be inserted into the VM/instance you are running and available on disk. The path of the settings file:</p><p><em>/var/lib/waagent/Microsoft.VisualStudio.Services.TeamServicesAgentLinux-versionnumber/config/uniquenumber.settings</em></p><p>The settings files contains the ProtectedSettings and Settings attribute of the extension, meaning the the token/JWT is available inside of the file. If you want to decrypt it manually, it is possible by using the Python module “HandlerUtil.py” as it contains a function to decode the settings using the computer certificate.</p><p>The code for it:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="nf">_parse_config</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">ctxt</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">JSON exception decoding </span><span class="sh">'</span> <span class="o">+</span> <span class="n">ctxt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">JSON error processing settings file:</span><span class="sh">"</span> <span class="o">+</span> <span class="n">ctxt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handlerSettings</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">runtimeSettings</span><span class="sh">'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="sh">'</span><span class="s">handlerSettings</span><span class="sh">'</span><span class="p">]</span>
            <span class="k">if</span> <span class="sh">'</span><span class="s">protectedSettings</span><span class="sh">'</span> <span class="ow">in</span> <span class="n">handlerSettings</span> <span class="ow">and</span> \
                    <span class="sh">"</span><span class="s">protectedSettingsCertThumbprint</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">handlerSettings</span> <span class="ow">and</span> \
                    <span class="n">handlerSettings</span><span class="p">[</span><span class="sh">'</span><span class="s">protectedSettings</span><span class="sh">'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                    <span class="n">handlerSettings</span><span class="p">[</span><span class="sh">'</span><span class="s">protectedSettings</span><span class="sh">'</span><span class="p">]</span> <span class="o">!=</span> <span class="sh">''</span> <span class="ow">and</span> \
                    <span class="n">handlerSettings</span><span class="p">[</span><span class="sh">"</span><span class="s">protectedSettingsCertThumbprint</span><span class="sh">"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">protectedSettings</span> <span class="o">=</span> <span class="n">handlerSettings</span><span class="p">[</span><span class="sh">'</span><span class="s">protectedSettings</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">thumb</span><span class="o">=</span><span class="n">handlerSettings</span><span class="p">[</span><span class="sh">'</span><span class="s">protectedSettingsCertThumbprint</span><span class="sh">'</span><span class="p">]</span>
                <span class="n">cert</span><span class="o">=</span><span class="n">waagent</span><span class="p">.</span><span class="n">LibDir</span><span class="o">+</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="o">+</span><span class="n">thumb</span><span class="o">+</span><span class="sh">'</span><span class="s">.crt</span><span class="sh">'</span>
                <span class="n">pkey</span><span class="o">=</span><span class="n">waagent</span><span class="p">.</span><span class="n">LibDir</span><span class="o">+</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="o">+</span><span class="n">thumb</span><span class="o">+</span><span class="sh">'</span><span class="s">.prv</span><span class="sh">'</span>
                <span class="n">waagent</span><span class="p">.</span><span class="nc">SetFileContents</span><span class="p">(</span><span class="sh">'</span><span class="s">/tmp/kk</span><span class="sh">'</span><span class="p">,</span> <span class="n">protectedSettings</span><span class="p">)</span>
                <span class="n">cleartxt</span><span class="o">=</span><span class="bp">None</span>
                <span class="n">cleartxt</span><span class="o">=</span><span class="n">waagent</span><span class="p">.</span><span class="nc">RunGetOutput</span><span class="p">(</span><span class="sh">"</span><span class="s">base64 -d /tmp/kk | openssl smime  -inform DER -decrypt -recip </span><span class="sh">"</span> <span class="o">+</span>  <span class="n">cert</span> <span class="o">+</span> <span class="sh">"</span><span class="s">  -inkey </span><span class="sh">"</span> <span class="o">+</span> <span class="n">pkey</span> <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">os</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="sh">"</span><span class="s">/tmp/kk</span><span class="sh">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cleartxt</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">OpenSSh decode error using  thumbprint </span><span class="sh">"</span> <span class="o">+</span> <span class="n">thumb</span> <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">do_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">operation</span><span class="p">,</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">,</span> <span class="n">operation</span> <span class="o">+</span> <span class="sh">'</span><span class="s"> Failed</span><span class="sh">'</span><span class="p">)</span>
                <span class="n">jctxt</span><span class="o">=</span><span class="sh">''</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">jctxt</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">cleartxt</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">self</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">'</span><span class="s">JSON exception decoding </span><span class="sh">'</span> <span class="o">+</span> <span class="n">cleartxt</span><span class="p">)</span>
                <span class="n">handlerSettings</span><span class="p">[</span><span class="sh">'</span><span class="s">protectedSettings</span><span class="sh">'</span><span class="p">]</span><span class="o">=</span><span class="n">jctxt</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="sh">'</span><span class="s">Config decoded correctly.</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span>
</pre></table></code></div></div><p><em>Example of settings file on disk.</em></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"runtimeSettings"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"handlerSettings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"protectedSettingsCertThumbprint"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C995E47CEFBD87EBA02B01E1BBFBA6D1A6E83352"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"protectedSettings"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MIIF3AYJKoZIhvcNAQcDoIIFzTCCBckCAQAxggFpMIIBZQIBADBNMDkxNzA1BgoJkiaJk/IsZAEZFidXaW5kb3dzIEF6dXJlIENSUCBDZXJ0aWZpY2F0ZSBHZW5lcmF0b3ICEE5Dxku1ulysRjLkep1nhIcwDQYJKoZIhvcNAQEBBQAEggEAf1+0EYEt/c4yDLdQTQemZMyWF8pUrjJuM222sHXiqQvzpzi0L+ezgRFQw+/3cr0QXUytuEOLsrWZcEziOONhZhaCaSD+58JRwU+Z006nJxg+rM06EP3ff12J36PfYR5/+YDYgs66uG6A+S3Y2ZoMczbCpRItH0iCeyFOnPSRGpWISqFA9tpw+HpqHWlY5WM8ugngsQSRPeUFtjb62e9z+LWvJq6z0nh7oIMUMLB/jCEIfUi7eH3egMLHZHaX+QD+O0B7gXD+L5d5a4+AXkkZle0eVuzdUJGgcwPGf56xGMYikHx0Yfuc9QtV+bCzRAcahalKE1WflyEmZU6aZHOrPjCCBFUGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQIbICCIhCAggQw0v+55ijfEDXiy7Tl+4JsG4pYVW1G2iI9iAXqAL4LcVFEvWE3+Q1UY59S34tbJAxxMbuoZX8ij97gE0+icQZL/sq6M3x0QXK+XGrIkG5nW/mGta7OGV/DKAaZt5jlKzgWq2klCrVSc5Xm3nuh+5mU3EltcAvc4q7wRsx4LWXC8AL4PIcD1SnjUrn7M87QrlMxG6GL3iSJEA8tUXDVgdoQKgUiatnQXOpTIcIiOIdFKrYJxbePUUSN5qyAf8rXZ4Ta9kp3xR0AdXtPQ0SHAbd+LaVztXzkbG8l7PnV4KJNXZCo4Vob7dN4crE7/abZZDV5FpWaWcZIeBIdcqAItHvFtQ8Rq9xwb/urI6vdbUZeVaI61+JLqp3ZLhIfzeejOtlH3HxQk4xofg+br5QEx2k+k47HAZE5xh5xRQwH6G5sSsYfDvFvFBmdaEJByfvh2Tv0a4JqYKoANjCVBvu5zAl88MukkIloxc1rdGtIyvBDC0uWYf2gFAE92g2a+B8EaYDFxOLQV8ZC1k1ZCtLQiYe/NdtbsUJnGPesdJ1sBLdmidclPO6gyB/HAXoJgdmx7ppFylO0A3RJnGyc85oORhc/qPkicT1a61aZlg+MrCwolQ2ImBZrzMCMWK/smgNEGJYa8ksPjhY3Mb1QHDFOc8uzQCFDhQI+F6psNbuvYrPdm4Jjcb5vIdlojEBMuWqbFwHX/29tPU/5tMZ2H+tABzI9b1CbdY5kbmTUQfX3+tQladdNF8hvS1WLgYuvOMpdn9sYiwOvmsKf8oolrzoQ4Occ2eAMhQDWAWyWr1M2E0KB6dEMQApwAoVVdPWicf+1WIMzyY6MoRW1FZbMtkqJDiZYJo0zmSmnpK1tCZWKh+1m83o5b5U34doFa7TZbRCjdDL1CYTEBQWGJdFHFh0ktqlg7pqihy6cpjJOhnEEaEEX74cTVx9nFCmAQPW/4dYeplq5gbT188/+kd5dKTcckp4uHLvH4+m2f09qp5Vv1vvYmenSn/B5uI9l4fr21kVuSaTyF3bEt9ajHKXho8sgHP2lRmla0pyRVPU/eEClCsXpJxKsYehQ76NA8jG51GvjUm5T1ZKPRxk94p98pWTjeAZ+6jJ0t0nG20tFST1YauQlj2Px9t1X3KQRwyO3rzlCKoMAVYtAykUsXesgIKt42FXqzbxkeVRIARkSHA2g2ELwYFsrZEZUa6zG3g5829vknWax6dDDe78CyjWE0EmdcZqlJMpEcEeUl/ObsgNnubPS8RLRO9ZSbvRAhTTUY7vhuH6O9zW9E+Awmg+nWHXKn6o+HGc/2S/jNdYaUPzZNwoHzYafoYQAuMonRs+PIpyNOSlw1ixEwyjqDRop0rGCHb0gj07yNp3XykXx0lIlEaNa1oPDQNey0NZo4pL6QJZ0/pA=="</span><span class="p">,</span><span class="w">
        </span><span class="nl">"publicSettings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"isPipelinesAgent"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nl">"agentFolder"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/agent"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"agentDownloadUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://internaltestfeed.blob.core.windows.net/devops/vsts-agent-linux-x64-2.211.1.tar.gz"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"enableScriptDownloadUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://internaltestfeed.blob.core.windows.net/devops/enableagent.sh"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>I have noticed in my tests that if you revoke or let the PAT Token expire, the agent will still be able to communicate and issue a new JWT to report back to Azure DevOps. There’s uncertainty on exactly how this works, and is probably maintained by Microsoft. I will however, try and do some more digging into this.</p><blockquote class="prompt-info"><p>The protected settings part of the settings file is encrypted, the VMSS instance has a computer certificate installed to decrypt the value. During the extension installation the protected settings on disk will be wiped after read. This can be intercepted in various ways, if you are interested to read the settings file. Part of the protected settings contains a JWT for the agent to authenticate to the Azure DevOps instance to call home.</p></blockquote><p>As the Azure DevOps agent also needs to install tools that might not exist on the machine, we will have to set the APT proxy as well.</p><p>There’s different ways of setting the apt proxy, however to keep it simple I have chosen to create the apt.conf file at /etc/apt with the content:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Acquire::http::Proxy "http://10.2.0.7:3128";
</pre></table></code></div></div><p>This can either be done by the CustomScript extension or as part of a golden image capturing. Once all of these configurations have been set in place, then you will successfully be able to use your proxy and reach Azure DevOps/APT.</p><p>Meaning the agent can now download the files needed, call home to Azure DevOps and download the dependencies needed to install successfully.</p><p>I hope this helps to cast some clarity on how the Azure DevOps agent extension works and how it can be used behind a proxy. Thank you for reading and if you enjoy the content I highly suggest that you checkout some of my great colleagues that’s been part of figuring this out!</p><p><a href="https://bjompen.com/#/">Björn Sundling</a></p><p><a href="https://blog.simonw.se/">Simon Wåhlin</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/azure-devops/'>Azure DevOps</a>, <a href='/categories/devops-agent/'>DevOps Agent</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/powershell/" class="post-tag no-text-decoration" >powershell</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >devops</a> <a href="/tags/extension/" class="post-tag no-text-decoration" >extension</a> <a href="/tags/virtual-machine/" class="post-tag no-text-decoration" >virtual machine</a> <a href="/tags/vmss/" class="post-tag no-text-decoration" >vmss</a> <a href="/tags/proxy/" class="post-tag no-text-decoration" >proxy</a> <a href="/tags/ubuntu/" class="post-tag no-text-decoration" >ubuntu</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Azure%20DevOps%20Pipeline%20Agent%20Extension%20(Ubuntu)%20-%20Behind%20a%20web%20proxy.%20-%20Sebastian%20Claesson&url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureDevOpsExtension-Linux%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Azure%20DevOps%20Pipeline%20Agent%20Extension%20(Ubuntu)%20-%20Behind%20a%20web%20proxy.%20-%20Sebastian%20Claesson&u=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureDevOpsExtension-Linux%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.sebastianclaesson.se%2Fposts%2FAzureDevOpsExtension-Linux%2F&text=Azure%20DevOps%20Pipeline%20Agent%20Extension%20(Ubuntu)%20-%20Behind%20a%20web%20proxy.%20-%20Sebastian%20Claesson" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SubscriptionVending/">Subscription Vending</a><li><a href="/posts/AzureDevOpsColoredOutput/">Azure DevOps Pipeline Output</a><li><a href="/posts/AzureDevOpsExtension-Linux/">Azure DevOps Pipeline Agent Extension (Ubuntu) - Behind a web proxy.</a><li><a href="/posts/AzureCrossTenantCollaboration/">Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</a><li><a href="/posts/AzureFunctions/">PowerShell Azure Function - Managed identity & triggers/bindings</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/NordicIntegrationSummit/"><div class="card-body"> <em class="small" data-ts="1729749600" data-df="ll" > Oct 24, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Nordic Integration Summit</h3><div class="text-muted small"><p> Nordic Integration Summit I attended the Nordic Integration Summit #NIS24 along with my colleagues to learn more about integration patterns that other companies implement and what we can expect of ...</p></div></div></a></div><div class="card"> <a href="/posts/AzureFunctions/"><div class="card-body"> <em class="small" data-ts="1660229700" data-df="ll" > Aug 11, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PowerShell Azure Function - Managed identity & triggers/bindings</h3><div class="text-muted small"><p> I’ve been playing around a little with Azure Functions and Azure Alerting. The design was to be able to utilize the Azure Alert rule processing function in Azure and have it create a prettier mail ...</p></div></div></a></div><div class="card"> <a href="/posts/AzureCrossTenantCollaboration/"><div class="card-body"> <em class="small" data-ts="1680526500" data-df="ll" > Apr 3, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</h3><div class="text-muted small"><p> The possibility to create Virtual network peerings across Azure Active Directory tenants has been available since 2018. It’s a feature which is allowed by default and is quite easy to setup and ge...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AzureDevOpsColoredOutput/" class="btn btn-outline-primary" prompt="Older"><p>Azure DevOps Pipeline Output</p></a> <a href="/posts/AzureCrossTenantCollaboration/" class="btn btn-outline-primary" prompt="Newer"><p>Azure AD Cross-tenant Collaboration / VNET Cross-tenant peering</p></a></div><script src="https://utteranc.es/client.js" repo="SebastianClaesson/sebastianclaesson.github.io" issue-term="pathname" crossorigin="anonymous" async> </script> <script type="text/javascript"> $(function() { const origin = "https://utteranc.es"; const iframe = "iframe.utterances-frame"; const lightTheme = "github-light"; const darkTheme = "github-dark"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } addEventListener("message", (event) => { let theme; /* credit to <https://github.com/utterance/utterances/issues/170#issuecomment-594036347> */ if (event.origin === origin) { /* page initial */ theme = initTheme; } else if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); } else { return; } const message = { type: "set-theme", theme: theme }; const utterances = document.querySelector(iframe).contentWindow; utterances.postMessage(message, origin); }); }); </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/powershell/">powershell</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/alert/">alert</a> <a class="post-tag" href="/tags/ansi/">ansi</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/azure-ad/">azure ad</a> <a class="post-tag" href="/tags/azure-devops/">azure devops</a> <a class="post-tag" href="/tags/b2b/">b2b</a> <a class="post-tag" href="/tags/claesson/">claesson</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/SebClaesson">Sebastian Claesson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LQDR23C4VN"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LQDR23C4VN'); }); </script>
